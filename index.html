<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>透析儀表板</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .progress-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      margin: auto;
    }
    .card { min-height: 200px; }
    .metric-value { font-size: 1.2em; margin-bottom: 10px; }
    .btn-analyse { background-color: #ffa500; border-color: #ffa500; color: #fff; }
    .btn-analyse:hover { background-color: #ff8c00; border-color: #ff8c00; }
  </style>
</head>
<body class="bg-light">
  <div class="container-fluid p-4">
    <!-- 年月篩選 -->
    <div class="row mb-4">
      <div class="col-md-2">
        <input type="month" id="startMonth" class="form-control" value="2021-01">
      </div>
      <div class="col-md-2">
        <input type="month" id="endMonth" class="form-control" value="2021-12">
      </div>
      <div class="col-md-2">
        <button id="btnLoad" class="btn btn-primary">分析</button>
      </div>
    </div>

    <div id="dataWarning" style="position: fixed; top: 10px; right: 10px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 8px 15px; font-size: 0.9em; border-radius: 5px; z-index: 9999; box-shadow: 0 0 6px rgba(0,0,0,0.1);">
      如未顯示數據請至此網址查看問題：
      <a href="https://github.com/yuyuhsiang/ccgh2/blob/master/README.md" target="_blank" style="color: #856404; text-decoration: underline;">前往說明</a>
    </div>

    <!-- 四個獨立折線圖 -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <i class="bi bi-graph-up"></i> 指標分析
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-4">
            <h6>血液透析次數</h6>
            <canvas id="chartHemoVisits" style="height:200px;"></canvas>
          </div>
          <div class="col-md-6 mb-4">
            <h6>腹膜透析次數</h6>
            <canvas id="chartPeriVisits" style="height:200px;"></canvas>
          </div>
          <div class="col-md-6 mb-4">
            <h6>血液透析人數</h6>
            <canvas id="chartHemoPatients" style="height:200px;"></canvas>
          </div>
          <div class="col-md-6 mb-4">
            <h6>腹膜透析比例</h6>
            <canvas id="chartPeriRatio" style="height:200px;"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入腳本 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script>
    // 註冊 datalabels 外掛
    Chart.register(ChartDataLabels);

    // 建立四個圖表實例並啟用 datalabels
    const ctxHemoVisits    = document.getElementById('chartHemoVisits').getContext('2d');
    const ctxPeriVisits    = document.getElementById('chartPeriVisits').getContext('2d');
    const ctxHemoPatients  = document.getElementById('chartHemoPatients').getContext('2d');
    const ctxPeriRatio     = document.getElementById('chartPeriRatio').getContext('2d');

    const chartHemoVisits = new Chart(ctxHemoVisits, {
      type: 'line',
      data: { labels: [], datasets: [{ label: '血液透析次數', data: [], borderColor: '#007bff' }] },
      options: {
        plugins: { datalabels: { align: 'top', color: '#007bff', font: { size: 12 } } }
      }
    });

    const chartPeriVisits = new Chart(ctxPeriVisits, {
      type: 'line',
      data: { labels: [], datasets: [{ label: '腹膜透析次數', data: [], borderColor: '#28a745' }] },
      options: {
        plugins: { datalabels: { align: 'top', color: '#28a745', font: { size: 12 } } }
      }
    });

    const chartHemoPatients = new Chart(ctxHemoPatients, {
      type: 'line',
      data: { labels: [], datasets: [{ label: '血液透析人數', data: [], borderColor: '#ffc107' }] },
      options: {
        plugins: { datalabels: { align: 'top', color: '#ffc107', font: { size: 12 } } }
      }
    });

    const chartPeriRatio = new Chart(ctxPeriRatio, {
      type: 'line',
      data: { labels: [], datasets: [{ label: '腹膜透析比例', data: [], borderColor: '#dc3545' }] },
      options: {
        scales: {
          y: { beginAtZero: true, title: { display: true, text: '比例' } }
        },
        plugins: {
          datalabels: {
            align: 'top',
            color: '#dc3545',
            font: { size: 12 },
            formatter: value => (value * 100).toFixed(1) + '%'
          }
        }
      }
    });

    function convertToROC(val) {
      const [y, m] = val.split('-');
      return `${parseInt(y) - 1911}-${m}`;
    }

    function loadSummary() {
      fetch('/api/summary')
        .then(r => r.json())
        .then(d => {
          document.getElementById('completionValue').textContent = d.completion_rate;
          document.getElementById('abnormalValue').textContent   = d.abnormal_rate;
          document.getElementById('metricsDetail').textContent  = `${d.completed_metrics}/${d.total_metrics}`;
        });
    }

    function updateCharts() {
      const startROC = convertToROC(document.getElementById('startMonth').value);
      const endROC   = convertToROC(document.getElementById('endMonth').value);
      fetch(`/api/data?start=${startROC}&end=${endROC}`)
        .then(r => r.json())
        .then(d => {
          [chartHemoVisits, chartPeriVisits, chartHemoPatients, chartPeriRatio].forEach(ch => ch.data.labels = d.labels);
          chartHemoVisits.data.datasets[0].data   = d.hemo_visits;
          chartPeriVisits.data.datasets[0].data   = d.peri_visits;
          chartHemoPatients.data.datasets[0].data = d.hemo_patients;
          chartPeriRatio.data.datasets[0].data    = d.peri_ratio;
          chartHemoVisits.update();
          chartPeriVisits.update();
          chartHemoPatients.update();
          chartPeriRatio.update();
        });
    }

    document.getElementById('btnLoad').addEventListener('click', updateCharts);
    document.getElementById('startMonth').addEventListener('change', updateCharts);
    document.getElementById('endMonth').addEventListener('change', updateCharts);
    window.addEventListener('DOMContentLoaded', () => {
      loadSummary();
      updateCharts();
    });
  </script>
</body>
</html>
